name: "Build AUTO"
on:
  push:
    # branches: [main, master]
    tags:
      - "v*.*.*"  # 当推送v开头的标签时触发CI/CD
    # paths:
    #   - '.github/workflows/build_tags.yml'
  workflow_dispatch: # 允许手动触发

env:
  FLUTTER_VERSION: '3.38.3'
  APP_NAME: 'em_image_water'
  APP_ID: com.emeric.image_water
  RELEASE_NAME: "Release ${{ github.ref_name }}"

jobs:
  build-uos:
    name: "Build UOS (ARM64)"
    # 使用官方 ARM Runner
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    
    # 【关键步骤】：为了兼容统信 UOS (GLIBC_2.28)，我们必须在 Debian 10 (Buster) 容器内构建
    # Debian 10 默认 GLIBC 版本正是 2.28
    container:
      image: arm64v8/debian:buster
      options: --user root # 确保有权限安装依赖

    steps:
      # 1. 修复 Debian 10 源列表（EOL 问题）
      - name: Fix Debian 10 Sources (EOL)
        run: |
          # 1. 备份原源列表（可选）
          rm -rf /etc/apt/sources.list.d/*
          rm -f /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian/ buster main contrib non-free" > /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian-security/ buster/updates main" >> /etc/apt/sources.list
          echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
          # 3. 删除可能存在的其他源配置，防止干扰
          rm -f /etc/apt/sources.list.d/*
          # 4. 更新并执行 dist-upgrade
          # 【关键点】 dist-upgrade 会强制同步（降级/升级）系统内的 libc6 等基础库
          # 确保它们与 archive 源里的版本完全一致，从而允许安装 dev 包。
          apt-get update
          apt-get -y dist-upgrade          

      # 2. 初始化构建环境（在容器内）
      - name: Install System Dependencies
        run: |
          apt-get update
          # 安装构建工具、Flutter 依赖、Git 和 AppImage 工具依赖
          apt-get install -y \
            git curl unzip clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-8-dev \
            build-essential libglu1-mesa-dev file wget fuse

      # 3. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 4. 手动 Git 配置 Flutter SDK 
      #   UOS 环境下使用 subosito/flutter-action 似乎有问题，手动GIT安装
      - name: Setup Flutter SDK via Git
        run: |
          echo "Cloning Flutter SDK..."
          # 使用指定的 Flutter 版本标签
          git clone https://github.com/flutter/flutter.git --depth 1 -b $FLUTTER_VERSION _flutter
          # 配置环境变量
          echo "$GITHUB_WORKSPACE/_flutter/bin" >> $GITHUB_PATH
          # 标记目录安全，防止 git 报错
          git config --global --add safe.directory $GITHUB_WORKSPACE/_flutter

      # 4. 验证 Flutter 环境并获取依赖
      - name: Flutter Doctor & Pub Get
        run: |
          # 将 flutter 路径加入当前 session
          # export PATH="$GITHUB_WORKSPACE/_flutter/bin:$PATH"
          # 禁用分析以加快速度
          flutter config --no-analytics
          # 预下载构件
          flutter precache --linux
          flutter doctor -v
          flutter pub get

      # 5. 构建 Release 包
      - name: Build Linux Release
        run: |
          # export PATH="$GITHUB_WORKSPACE/_flutter/bin:$PATH"
          flutter build linux --release --target-platform=linux-arm64

      # 6. 准备 AppImage 构建工具 (LinuxDeploy)
      - name: Setup AppImage Tools
        run: |
          # 下载 LinuxDeploy (aarch64)
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          chmod +x linuxdeploy-aarch64.AppImage
          # 由于在 Docker内,FUSE 可能无法工作，我们解压使用
          ./linuxdeploy-aarch64.AppImage --appimage-extract
          rm linuxdeploy-aarch64.AppImage
          mv squashfs-root linuxdeploy-root

      # 7. 打包 AppImage
      - name: Package AppImage
        run: |
          # 设置变量
          BUILD_DIR=build/linux/arm64/release/bundle
          APP_DIR=AppDir
          
          # 创建 AppDir 结构
          mkdir -p $APP_DIR/usr/bin
          mkdir -p $APP_DIR/usr/lib
          mkdir -p $APP_DIR/usr/share/applications
          mkdir -p $APP_DIR/usr/share/icons/hicolor/256x256/apps
          
          # 复制二进制文件和资源
          cp -r $BUILD_DIR/* $APP_DIR/usr/bin/
          # 通常 Flutter 构建出来的二进制文件名就是 pubspec.yaml 中的 name
          # 假设二进制文件名为 my_flutter_app (请根据实际情况修改下面的 * )
          BINARY_NAME=$(find $APP_DIR/usr/bin -maxdepth 1 -type f -executable ! -name "*.so" -printf "%f" | head -n 1)
          echo "Detected Binary Name: $BINARY_NAME"
          
          # 创建 .desktop 文件 (如果项目没有，这里动态生成)
          cat > $APP_DIR/usr/share/applications/${{ env.APP_ID }}.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=${{ env.APP_NAME }}
          Exec=$BINARY_NAME
          Icon=${{ env.APP_ID }}
          Categories=Utility;
          EOF
          
          # 复制图标 (假设项目根目录有 assets/icon512.png)
          cp web/icons/Icon-512.png $APP_DIR/usr/share/icons/hicolor/256x256/apps/${{ env.APP_ID }}.png

          # 使用 LinuxDeploy 自动打包依赖库 (GTK等)
          # 注意：在 Docker 内需要设置 ARCH=arm64 并可能需要禁用 git 更新检查
          export ARCH=arm64
          export LINUXDEPLOY="./linuxdeploy-root/AppRun"
          
          $LINUXDEPLOY --appdir $APP_DIR \
            --executable $APP_DIR/usr/bin/$BINARY_NAME \
            --desktop-file $APP_DIR/usr/share/applications/${{ env.APP_ID }}.desktop \
            --icon-file $APP_DIR/usr/share/icons/hicolor/256x256/apps/${{ env.APP_ID }}.png \
            --output appimage

      # 8. 上传产物
      - name: Upload Artifact
        if: "!startsWith(github.ref, 'refs/tags/v')"
        uses: actions/upload-artifact@v4
        with:
          name: flutter-app-uos-arm64
          path: "*.AppImage"

      - name: Upload Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ env.RELEASE_NAME }}
          generate_release_notes: true
          files: "*.AppImage"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-x86:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 配置 Flutter
        uses: subosito/flutter-action@v2.13.0
        with:
          flutter-version: "${{ env.FLUTTER_VERSION }}" # 使用全局版本变量
          cache: false
          
      - name: 安装 Linux 依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-10-dev \
            build-essential libglu1-mesa-dev file wget fuse
          
      - name: 获取 Flutter 依赖
        run: |
          flutter pub get
          flutter clean

      - name: 构建 Linux x86_64
        run: |
          flutter build linux --release

      - name: 打包 Linux AppImage
        run: |
          # 创建 AppDir 结构
          BUILD_DIR=build/linux/x64/release/bundle
          APP_DIR=AppDir
          
          mkdir -p $APP_DIR/usr/bin
          mkdir -p $APP_DIR/usr/lib
          mkdir -p $APP_DIR/usr/share/applications
          mkdir -p $APP_DIR/usr/share/icons/hicolor/256x256/apps
          
          # 复制构建产物
          cp -r $BUILD_DIR/* $APP_DIR/usr/bin/
          
          # 获取二进制文件名
          BINARY_NAME=$(find $APP_DIR/usr/bin -maxdepth 1 -type f -executable ! -name "*.so" -printf "%f" | head -n 1)
          echo "Detected Binary Name: $BINARY_NAME"
          
          # 创建 .desktop 文件
          cat > $APP_DIR/usr/share/applications/${{ env.APP_NAME }}.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=${{ env.APP_NAME }}
          Exec=$BINARY_NAME
          Icon=${{ env.APP_NAME }}
          Categories=Utility;
          EOF

          if [ ! -f "$APP_DIR/usr/share/applications/${{ env.APP_NAME }}.desktop" ]; then
            echo "Error: Desktop file creation failed"
            exit 1
          fi
          echo "Desktop file created successfully: $APP_DIR/usr/share/applications/${{ env.APP_NAME }}.desktop"
          
          # 复制图标
          cp web/icons/Icon-512.png $APP_DIR/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png
          
          # 确保图标存在
          if [ ! -f "$APP_DIR/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png" ]; then
            echo "Error: Icon file creation failed"
            exit 1
          fi
          echo "Icon file copied successfully"

          # 下载并准备 linuxdeploy 工具（解压以确保在Docker环境中能运行）
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          ./linuxdeploy-x86_64.AppImage --appimage-extract
          rm linuxdeploy-x86_64.AppImage
          mv squashfs-root linuxdeploy-root
          
          # 使用 linuxdeploy 构建 AppImage
          ./linuxdeploy-root/AppRun --appdir $APP_DIR \
            --executable $APP_DIR/usr/bin/$BINARY_NAME \
            --desktop-file $APP_DIR/usr/share/applications/${{ env.APP_NAME }}.desktop \
            --icon-file $APP_DIR/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png \
            --output appimage

      - name: 上传 Linux x86_64 Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ env.RELEASE_NAME }}
          generate_release_notes: true
          files: "*.AppImage"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 配置 Flutter
        uses: subosito/flutter-action@v2.13.0
        with:
          flutter-version: "${{ env.FLUTTER_VERSION }}" # 使用全局版本变量
          cache: false
          
      - name: install Flutter dependencies
        run: |
          flutter pub get
          flutter clean

      - name: prepare Windows  (x86)
        run: |
          flutter config --enable-windows-desktop

      - name: build Windows x86 
        run: |
          flutter build windows --release
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath ${{ env.APP_NAME }}-windows-x64.zip

      - name: upload Windows x86
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ env.RELEASE_NAME }}
          generate_release_notes: true
          files: ${{ env.APP_NAME }}-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2.13.0
        with:
          flutter-version: "${{ env.FLUTTER_VERSION }}" # 使用全局版本变量
          cache: false
          
      - name: Install Flutter dependencies
        run: |
          flutter doctor -v
          flutter --version 
          flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ env.RELEASE_NAME }}
          generate_release_notes: true
          files: build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
